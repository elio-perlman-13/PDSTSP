name: Run tabubu per instance

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - restore-branch

jobs:
  prepare:
    name: Prepare matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build JSON matrix from instance/*.txt
        id: set-matrix
        run: |
          items=()
          for f in instance/*.txt; do
            if [ -f "$f" ]; then
              base=$(basename "$f" .txt)
              # escape quotes in path just in case
              file=$(printf '%s' "$f" | sed 's/"/\\"/g')
              base=$(printf '%s' "$base" | sed 's/"/\\"/g')
              items+=("{\"file\":\"$file\",\"base\":\"$base\"}")
            fi
          done
          if [ ${#items[@]} -eq 0 ]; then
            echo "No instance files found under instance/"; exit 1
          fi
          # join items with commas to produce valid JSON array
          matrix_json="$(printf '%s,' "${items[@]}")"
          matrix_json="[${matrix_json%,}]"
          echo "matrix=$matrix_json" >> "$GITHUB_OUTPUT"

  # NEW: Build the solver once
  build:
    name: Build solver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile solver
        run: |
          # ubuntu-latest has g++ pre-installed.
          # -march=native: optimize for the cloud CPU
          # -DNDEBUG: disable assertions for speed
          # -O3: max optimization
          g++ -O3 -std=c++20 -march=native -DNDEBUG -pthread -o tabubu tabubu.cpp 

      - name: Upload solver binary
        uses: actions/upload-artifact@v4
        with:
          name: solver-bin
          path: tabubu
          retention-days: 1

  run-instance:
    name: Run instance ${{ matrix.base }}
    needs: [prepare, build] # Wait for build to finish
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}
      max-parallel: 64
    runs-on: ubuntu-latest
    timeout-minutes: 359
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Download the pre-built binary
      - name: Download solver
        uses: actions/download-artifact@v4
        with:
          name: solver-bin

      - name: Make executable
        run: chmod +x tabubu

      - name: Run tabubu on instance
        timeout-minutes: 355 # slightly less than job timeout to allow cleanup steps to run
        run: |
          mkdir -p outputs
          ./tabubu "${{ matrix.file }}" > "outputs/${{ matrix.base }}.log" 2>&1 || true

      - name: Prepare outputs
        if: always()
        run: |
          # copy solver's best output if created
          if [[ -f output_solution_best.txt ]]; then
            cp output_solution_best.txt "outputs/${{ matrix.base }}_best.txt"
          fi

      - name: Upload per-instance artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.base }}-tabubu-results
          path: |
            outputs/${{ matrix.base }}_best.txt
            outputs/${{ matrix.base }}.log
          if-no-files-found: warn

  collect-all:
    name: Collect and compress all artifacts
    runs-on: ubuntu-latest
    if: always()
    needs: run-instance
    timeout-minutes: 60
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifact dirs:"
          ls -la all_artifacts || true

      - name: Consolidate into summary directory
        run: |
          rm -rf summary || true
          mkdir -p summary
          # copy only per-instance *_best.txt into per-artifact subfolders
          for a in all_artifacts/*; do
            name=$(basename "$a")
            mkdir -p "summary/$name"
            # copy only files ending with _best.txt
            find "$a" -type f -name '*_best.txt' -exec cp {} "summary/$name/" \; || true
          done

      - name: Create final compressed summary
        run: |
          tar -czf tabubu_all_instances_summary.tar.gz -C summary .

      - name: Upload consolidated summary
        uses: actions/upload-artifact@v4
        with:
          name: tabubu_all_instances_summary
          path: tabubu_all_instances_summary.tar.gz